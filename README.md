# 🧾 Smart Receipt OCR System

> **PaddleOCR 기반의 지능형 영수증 분석 및 국세청 과세유형 자동 조회 시스템**

이 프로젝트는 대량의 영수증 이미지를 업로드하면 **텍스트 추출(OCR) → 주요 정보 파싱 → 국세청 과세유형 조회** 과정을 거쳐 엑셀(CSV) 및 결과 이미지로 정리해 주는 웹 서비스입니다.

## ✨ 주요 특징 (Key Features)

* **⚡ 초고속 병렬 처리:** 멀티 프로세싱 기술을 적용하여 여러 장의 영수증을 동시에 분석합니다.
* **📊 실시간 피드백:** 작업이 완료되는 순서대로 화면에 즉시 결과가 나타나며 진행률을 확인할 수 있습니다.
* **🔒 사용자 데이터 격리:** 접속자별 IP를 인식하여 본인의 데이터만 안전하게 관리합니다.
* **🔍 국세청 연동:** 추출된 사업자 번호를 바탕으로 일반/간이/면세 등 과세유형을 실시간 조회합니다.
* **📂 일괄 다운로드:** 분석된 원본 파일과 OCR 결과 이미지를 각각 ZIP 압축 파일로 다운로드할 수 있습니다.

---

## 🚀 시작하기 (Installation)

### 1. 환경 준비

Python 3.8 이상의 환경이 필요합니다.

```bash
# 저장소 복제
git clone https://github.com/your-username/receipt-ocr-system.git
cd receipt-ocr-system

# 필요 라이브러리 설치
pip install -r requirements.txt

```

### 2. 설정 (Config)

`config.yaml` 파일에 국세청 API 서비스 키와 저장 경로를 설정합니다.

```yaml
ocr:
  default_service_key: "여러분의_국세청_API_키"
  upload_dir: "storage/upload"
  result_dir: "storage/result"

```

### 3. 서버 실행

```bash
python main.py

```

실행 후 브라우저에서 `http://localhost:8000`으로 접속하세요.

---

## 🛠 사용 방법 (Usage)

1. **파일 업로드:** 화면 중앙의 점선 영역(`Upload Zone`)에 영수증 이미지(JPG, PNG)나 PDF 파일을 드래그 앤 드롭합니다.
2. **API 키 입력(선택):** 기본 키 외에 본인의 국세청 API 키를 사용하려면 우측 상단 설정 아이콘을 눌러 입력합니다.
3. **분석 시작:** `OCR 처리 시작` 버튼을 클릭합니다.
* *클릭 시 이전 작업 내역은 자동으로 초기화됩니다.*


4. **실시간 모니터링:** 테이블에 영수증 정보가 하나씩 추가되는 것을 확인합니다.
5. **오류 수정:** 과세유형 조회가 실패한 경우, 해당 행의 `재조회` 버튼을 눌러 다시 시도할 수 있습니다. (인터넷 연결 필수)
6. **결과 저장:** 모든 처리가 끝나면 `CSV 다운로드` 또는 `압축 파일(ZIP) 다운로드` 버튼을 눌러 결과를 저장합니다.

---

## 📂 프로젝트 구조 (Project Structure)

* `main.py`: FastAPI 웹 서버 및 API 엔드포인트 관리
* `worker.py`: 멀티 프로세싱 기반의 실제 OCR 연산 워커
* `receipt_parser_paddle_multi_thread.py`: 영수증 텍스트 파싱 및 국세청 조회 로직
* `index.html`: 사용자 친화적인 웹 인터페이스 (Vanilla JS)
* `storage/`: 유저별/IP별 데이터 격리 저장소

---

## 📝 라이선스

이 프로젝트는 개인 및 사내 관리용으로 제작되었습니다. 사용된 PaddleOCR 모델의 라이선스를 준수합니다.

---

## 🧾 영수증 OCR 관리 시스템 개발 현황 보고

### 1. 프로젝트 개요

PaddleOCR 기반의 멀티 프로세싱 기술을 활용하여 대량의 영수증 이미지를 분석하고, 사업자 번호, 가맹점명, 결제 금액 등을 추출하여 국세청 과세유형까지 자동으로 분류하는 웹 관리 시스템입니다.

---

### 2. 주요 요구사항 및 해결 방안

| 구분 | 요구사항 | 해결 방안 (구현 내용) |
| --- | --- | --- |
| **성능** | 수십 장의 영수증을 빠르게 처리해야 함 | **멀티 프로세싱(`ProcessPoolExecutor`)** 적용으로 CPU 코어 병렬 활용 |
| **보안/격리** | 사용자 간 데이터가 섞이거나 노출되면 안 됨 | 유저 **IP별 고유 디렉토리 격리** 시스템 구축 |
| **사용성** | 실시간 처리 현황을 눈으로 보고 싶음 | **NDJSON 스트리밍 전송**을 통해 작업 완료 건별 실시간 UI 반영 |
| **정확도** | 국세청 조회 실패 시 대처 수단 필요 | 실패 건에 대한 **개별 재조회 버튼** 및 **인터넷 연결 체크** 로직 구현 |
| **편의성** | 분석 결과를 엑셀로 저장하고 싶음 | BOM 처리가 완료된 **CSV 다운로드** 및 이미지 일괄 ZIP 다운로드 제공 |

---

### 3. 세부 개발 항목 (Technical Stack)

#### **[Backend] FastAPI & Python**

* **다중 사용자 격리:** `request.client.host`를 식별자로 사용하여 `storage/upload/{IP}`, `storage/result/{IP}` 하위 폴더에서만 작업 수행.
* **실시간 스트리밍 API:** `asyncio.as_completed`를 사용하여 먼저 끝난 작업부터 `StreamingResponse`로 클라이언트에 즉시 전송.
* **자동 데이터 클리닝:** 페이지 최초 접속(`GET /`) 및 분석 시작 버튼 클릭 시 이전 작업 데이터(임시 파일 등) 자동 삭제.
* **과세유형 재조회:** 특정 사업자 번호로 국세청 API를 다시 호출하는 전용 엔드포인트 마련.

#### **[Frontend] Vanilla JS & Bootstrap**

* **실시간 대시보드:** `Fetch API`의 `ReadableStream`을 사용하여 서버에서 오는 데이터를 한 줄씩 읽어 테이블에 실시간 렌더링.
* **진행률 표시:** `처리 중 (N/M)` 형태의 텍스트 피드백으로 전체 작업 대비 진행률 노출.
* **스마트 버튼:** 분석 중 버튼 비활성화, 국세청 조회 실패 시에만 '재조회' 버튼 노출.
* **네트워크 상태 감지:** 브라우저의 `navigator.onLine`을 활용하여 네트워크 단절 시 사용자에게 알림.

#### **[Worker] PaddleOCR & Image Processing**

* **멀티 프로세싱 워커:** 개별 프로세스 내에서 OCR 엔진을 초기화하여 직렬화(Serialization) 에러 방지 및 속도 극대화.
* **시각화:** OCR 결과(BBox)가 그려진 이미지와 정리된 원본 이미지를 각각 생성.

---

### 4. 현재 워크플로우 (Summary)

1. **접속:** 사용자가 접속하면 IP를 식별하고 기존 쓰레기 파일 정리.
2. **업로드:** 드래그 앤 드롭으로 다수의 파일 업로드.
3. **시작:** 버튼 클릭 즉시 테이블 초기화 및 서버 병렬 연산 시작.
4. **피드백:** 작업이 완료되는 순서대로 화면에 데이터가 하나씩 탁-탁-탁 나타나며 진행률 갱신.
5. **사후처리:** 실패한 과세 유형은 '재조회' 버튼으로 개별 처리 후, 전체 결과를 CSV나 ZIP으로 획득.

---

## ToDo

1. 과세조회 실패 시 재조회 기능 검증 필요


## Troubleshooting

1. Ubuntu 에서 한글 폰트가 깨짐

- 나눔 폰트 설치하기

```bash
sudo apt-get install fonts-nanum*
```

- 폰트 캐시 삭제

```bash
fc-cache -fv
```

2. NotImplementedError (Unimplemented) ~~~ 에러

paddlepaddle 을 3.0.0 으로 설치한다.